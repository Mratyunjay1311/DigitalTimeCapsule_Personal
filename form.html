<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
  /* Global background with antique feel */
  body {
    margin: 0;
    padding: 0;
    font-family: 'Georgia', serif;
    background: linear-gradient(to right, #fff8f2, #f5eee6);
    color: #3a2f2f;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Frosted-glass antique form box */
  #capsuleData {
    backdrop-filter: blur(10px);
    background: rgba(255, 248, 240, 0.75);
    border: 2px solid rgba(9, 146, 250, 0.3);
    border-radius: 20px;
    padding: 40px 30px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    animation: fadeInUp 1s ease-out;
  }

  @keyframes fadeInUp {
    0% {
      opacity: 0;
      transform: translateY(40px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  label {
    font-weight: bold;
    color: #5c3d2e;
    font-size: 16px;
    margin-bottom: 5px;
  }

  input[type="text"],
  input[type="file"],
  input[type="date"],
  textarea {
    padding: 12px 14px;
    font-size: 15px;
    border: 1px solid #d6bfa9;
    border-radius: 10px;
    outline: none;
    background: rgba(255, 255, 255, 0.85);
    transition: box-shadow 0.3s ease;
  }

  input:focus,
  textarea:focus {
    box-shadow: 0 0 0 2px #0981fa70;
  }

  textarea {
    resize: vertical;
    min-height: 100px;
  }

  button[type="submit"] {
    background: #7da9d7;
    color: #fff;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 12px rgba(9, 109, 250, 0.4);
  }

  button[type="submit"]:hover {
    background-color: #1c7ce4;
    box-shadow: 0 6px 16px rgba(9, 146, 250, 0.6);
  }

  /* Spinner Styles */
  #spinner {
    position: fixed;
    display: none;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.85);
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(3px);
  }

  .loader {
    border: 8px solid #f3f3f3;
    border-top: 8px solid #0992fa;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Optional: subtle glowing header */
  h1 {
    text-align: center;
    font-family: 'Georgia', serif;
    color: #5c3d2e;
    text-shadow: 1px 1px 1px rgba(255,255,255,0.8);
    margin-bottom: 20px;
  }
</style>


        
</head>
<body>
    <form action="" id="capsuleData">
        <label for="name">Name</label>
<input type="text" id="name" >
<label for="">Message</label>
<textarea name="message" id="message"></textarea>
<label for="file">Upload File</label>
<input type="file" name="" id="file" multiple>

 <label for="date">Select Date</label>

<input type="date" name="date" id="date" min="">
<button type="submit">Save</button>
    </form>
<div id="spinner">
  <div class="loader"></div>
</div>

    
</body> 
</html>

<script type="module">
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
import { db } from "./firebase-config.js";

import { getAuth } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

const auth = getAuth();
 const spinner = document.getElementById('spinner')

  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").setAttribute("min", today);
  });


    




async function uploadToCloudinary(file) {

  const cloudName = "dk3qwx0db";
const uploadPreset = "timecapsule";
  const url = `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", uploadPreset);

  const res = await fetch(url, {
    method: "POST",
    body: formData
  });

 

  const data = await res.json();

  if (!res.ok || data.error) {
    throw new Error("Cloudinary Error: " + (data.error?.message || res.statusText));
}
  return data.secure_url; // this is the file URL
}




document.getElementById("capsuleData").addEventListener("submit", async (e) => {
  e.preventDefault();

const name = document.getElementById("name").value;
const message = document.getElementById("message").value;
const date = document.getElementById("date").value;
 const files = document.getElementById("file").files;

 if (!name || !message || !date || files.length === 0) {
  alert("Please fill all fields and select at least one file.");
  return;
}


 const selectedDateStr = date;
const todayStr = new Date().toISOString().split("T")[0];

if (selectedDateStr <= todayStr) {
  alert("Please select a future date for unlocking the capsule.");
  document.getElementById("capsuleData").reset();
  return;
}
 spinner.style.display = "flex";
  


try{

    if (!auth.currentUser) {
          alert("You must be logged in to save your capsule.");
          spinner.style.display = "none";
          return;
        }
const uploadedURLs = [];
for (let i = 0; i < files.length; i++) {
  console.log("File to upload:", files[i]);

  const url = await uploadToCloudinary(files[i]);
  uploadedURLs.push(url);
}


const capsuleData = {
  name,
  message,
  date,
  files: uploadedURLs, 
   userId: auth.currentUser.uid 
};



    
    await setDoc(doc(db, "capsules", Date.now().toString()), capsuleData);

  alert("Data saved successfully!");

   document.getElementById("capsuleData").reset();
      
      window.location.href = 'capsulepage.html'

} catch (error) {
    alert("Failed to save data. Please try again.");

}finally {
  spinner.style.display = "none";
}

});



 

</script>





